{% extends "base.html" %}
{% block title %}Pipeline — Fiarrd{% endblock %}
{% block content %}

<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:24px">
  <h1 style="margin:0">Pipeline</h1>
  <div style="display:flex;gap:10px;align-items:center">
    <span id="score-result" style="font-size:13px;color:#64748b"></span>
    <button class="btn btn-ghost btn-sm" id="score-btn" onclick="scoreUnscored()" style="white-space:nowrap">Score Unscored ✦</button>
    <a href="/export" class="btn btn-ghost btn-sm" style="white-space:nowrap">Export CSV ↓</a>
  </div>
</div>

<!-- Filters -->
<div class="card" style="padding:14px 20px;margin-bottom:20px">
  <form method="GET" style="display:flex;gap:12px;align-items:flex-end;flex-wrap:wrap">
    <div>
      <label>Stage</label>
      <select name="stage" onchange="this.form.submit()">
        <option value="">All stages</option>
        {% for s in stage_order %}
        <option value="{{ s }}" {% if current_stage == s %}selected{% endif %}>{{ s }}</option>
        {% endfor %}
      </select>
    </div>
    <div>
      <label>Tier</label>
      <select name="tier" onchange="this.form.submit()">
        <option value="">All tiers</option>
        {% for t in [1,2,3] %}
        <option value="{{ t }}" {% if current_tier == t %}selected{% endif %}>Tier {{ t }}</option>
        {% endfor %}
      </select>
    </div>
    <div>
      <label>Job Family</label>
      <select name="job_family" onchange="this.form.submit()">
        <option value="">All families</option>
        {% for k, v in job_families.items() %}
        <option value="{{ k }}" {% if current_family == k %}selected{% endif %}>{{ v }}</option>
        {% endfor %}
      </select>
    </div>
    <a href="/opportunities" class="btn btn-ghost btn-sm">Clear</a>
  </form>
</div>

{% if opportunities %}
<div class="card" style="padding:0;overflow:hidden">
  <table id="opp-table">
    <thead>
      <tr>
        <th style="width:36px;padding:10px 8px 10px 16px">
          <input type="checkbox" id="select-all" title="Select all" onchange="toggleAll(this.checked)">
        </th>
        <th>Company</th>
        <th>Role</th>
        <th>Stage</th>
        <th>Tier</th>
        <th>Family</th>
        <th>Fit</th>
        <th>Next Action</th>
        <th>Due</th>
        <th>Added</th>
      </tr>
    </thead>
    <tbody>
      {% for opp in opportunities %}
      <tr>
        <td style="padding:10px 8px 10px 16px">
          <input type="checkbox" class="opp-cb" value="{{ opp.id }}" onchange="onCheckChange()">
        </td>
        <td><a href="/opportunity/{{ opp.id }}">{{ opp.company }}</a></td>
        <td style="max-width:220px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">{{ opp.role_title }}</td>
        <td>
          <span class="badge {% if opp.stage in ['Offer Pending'] %}badge-green{% elif opp.stage == 'Closed' %}badge-gray{% elif opp.stage in ['HM Interview','Loop'] %}badge-purple{% elif opp.stage == 'Recruiter Screen' %}badge-blue{% else %}badge-yellow{% endif %}">
            {{ opp.stage }}
          </span>
        </td>
        <td style="color:#64748b">{% if opp.tier %}T{{ opp.tier }}{% else %}—{% endif %}</td>
        <td style="color:#64748b;font-size:12px">{{ job_families.get(opp.job_family, '—') if opp.job_family else '—' }}</td>
        <td>
          {% if opp.fit_score %}
          <div style="font-size:12px;font-weight:600;color:{% if opp.fit_score >= 8 %}#10b981{% elif opp.fit_score >= 6 %}#f59e0b{% else %}#ef4444{% endif %}">
            {{ opp.fit_score }}/10
          </div>
          {% else %}—{% endif %}
        </td>
        <td style="color:#94a3b8;font-size:12px;max-width:180px">{{ opp.next_action or '—' }}</td>
        <td style="font-size:12px;{% if opp.next_action_date and opp.next_action_date <= now|default('') %}color:#ef4444{% endif %}">
          {{ opp.next_action_date or '—' }}
        </td>
        <td style="color:#64748b;font-size:12px">{{ opp.date_added or '—' }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- Bulk action bar (hidden until rows are selected) -->
<div id="bulk-bar" style="display:none;position:fixed;bottom:24px;left:50%;transform:translateX(-50%);
     background:#1e293b;border:1px solid #334155;border-radius:10px;padding:12px 20px;
     display:flex;align-items:center;gap:12px;box-shadow:0 8px 24px rgba(0,0,0,.5);z-index:100">
  <span id="bulk-count" style="font-size:13px;color:#94a3b8;white-space:nowrap">0 selected</span>
  <select id="bulk-stage" style="min-width:160px">
    <option value="">Move to stage…</option>
    {% for s in stage_order %}
    <option value="{{ s }}">{{ s }}</option>
    {% endfor %}
    <option value="Closed">Closed</option>
  </select>
  <button class="btn btn-primary btn-sm" onclick="bulkAdvance()">Update</button>
  <span id="bulk-result" style="font-size:13px;color:#64748b"></span>
  <button class="btn btn-ghost btn-sm" onclick="clearAll()">✕</button>
</div>
{% else %}
<div class="card empty-state">
  No opportunities found. Add your first with: <code>python main.py add-job</code>
</div>
{% endif %}

<script>
function scoreUnscored() {
  const btn = document.getElementById('score-btn');
  const result = document.getElementById('score-result');
  btn.disabled = true;
  btn.textContent = 'Scoring…';
  result.textContent = '';
  fetch('/opportunities/score-unscored', {method: 'POST'})
    .then(r => r.json())
    .then(data => {
      btn.disabled = false;
      btn.textContent = 'Score Unscored ✦';
      if (data.error) {
        result.style.color = '#ef4444';
        result.textContent = data.error;
        return;
      }
      result.style.color = data.scored > 0 ? '#10b981' : '#64748b';
      result.textContent = data.message || `Scored ${data.scored}` + (data.errors ? `, ${data.errors} failed` : '') + '.';
      if (data.scored > 0) setTimeout(() => location.reload(), 1000);
    })
    .catch(() => {
      btn.disabled = false;
      btn.textContent = 'Score Unscored ✦';
      result.style.color = '#ef4444';
      result.textContent = 'Request failed.';
    });
}
function getSelected() {
  return Array.from(document.querySelectorAll('.opp-cb:checked')).map(cb => cb.value);
}
function toggleAll(checked) {
  document.querySelectorAll('.opp-cb').forEach(cb => cb.checked = checked);
  onCheckChange();
}
function clearAll() {
  document.querySelectorAll('.opp-cb').forEach(cb => cb.checked = false);
  document.getElementById('select-all').checked = false;
  onCheckChange();
}
function onCheckChange() {
  const ids = getSelected();
  const bar = document.getElementById('bulk-bar');
  document.getElementById('bulk-count').textContent = ids.length + ' selected';
  bar.style.display = ids.length > 0 ? 'flex' : 'none';
}
function bulkAdvance() {
  const ids = getSelected();
  const stage = document.getElementById('bulk-stage').value;
  const result = document.getElementById('bulk-result');
  if (!ids.length || !stage) {
    result.style.color = '#ef4444';
    result.textContent = ids.length ? 'Pick a stage.' : 'Nothing selected.';
    return;
  }
  result.textContent = 'Updating…';
  result.style.color = '#64748b';
  const body = new URLSearchParams();
  ids.forEach(id => body.append('opp_ids[]', id));
  body.append('new_stage', stage);
  fetch('/opportunities/bulk-advance', {method: 'POST', body})
    .then(r => r.json())
    .then(data => {
      if (data.error) {
        result.style.color = '#ef4444';
        result.textContent = data.error;
        return;
      }
      result.style.color = '#10b981';
      result.textContent = `Updated ${data.updated}/${data.total}.`;
      setTimeout(() => location.reload(), 800);
    })
    .catch(() => {
      result.style.color = '#ef4444';
      result.textContent = 'Request failed.';
    });
}
</script>
{% endblock %}
